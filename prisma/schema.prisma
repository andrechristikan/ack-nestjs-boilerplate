datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}
model ApiKey {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  type          ENUM_API_KEY_TYPE @default(DEFAULT)
  name          String
  key           String
  hash          String
  isActive      Boolean           @default(true)
  startAt     DateTime?
  endAt       DateTime?

  // timestamps fields
  createdAt DateTime? @default(now())
  createdBy String?
  updatedAt DateTime? @updatedAt
  updatedBy String?

  @@unique(fields: [key])
  @@unique(fields: [hash])
  @@index(fields: [createdBy, createdAt])
  @@index(fields: [type])
  @@index(fields: [name])
  @@index(fields: [createdAt])
  @@map("ApiKeys")
}

model Role {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  type        ENUM_ROLE_TYPE @default(USER)
  abilities   Json[]         @default([])

  // timestamps fields
  createdAt DateTime? @default(now())
  createdBy String?
  updatedAt DateTime? @updatedAt
  updatedBy String?

  users User[] @relation("UserRole")

  @@unique(fields: [name])
  @@index(fields: [type])
  @@index(fields: [createdAt])
  @@map("Roles")
}

model Country {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  alpha2Code String
  alpha3Code String
  phoneCode  String[]
  continent  String
  timezone   String

  mobileNumbers UserMobileNumber[] @relation("UserMobileNumberCountry")
  users         User[]       @relation("UserCountry")

  // timestamps fields
  createdAt DateTime? @default(now())
  createdBy String?
  updatedAt DateTime? @updatedAt
  updatedBy String?

  @@unique(fields: [alpha2Code])
  @@unique(fields: [alpha3Code])
  @@index(fields: [name])
  @@index(fields: [continent])
  @@index(fields: [createdAt])
  @@map("Countries")
}

model UserMobileNumber {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  userId       String    @db.ObjectId
  countryId    String    @db.ObjectId
  phoneCode   String
  number String
  isVerified   Boolean   @default(false)
  verifiedAt   DateTime?

  // timestamps fields
  createdAt DateTime? @default(now())
  createdBy String?
  updatedAt DateTime? @updatedAt
  updatedBy String?

  country Country? @relation("UserMobileNumberCountry", fields: [countryId], references: [id])
  user    User?    @relation("UserMobileNumberUser", fields: [userId], references: [id])

  @@unique(fields: [number])
  @@index(fields: [userId])
  @@index(fields: [isVerified])
  @@index(fields: [createdAt])
  @@map("UserMobiles")
}

model User {
  id              String                  @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  username        String
  isVerified      Boolean                 @default(false)
  verifiedAt      DateTime?
  email           String
  roleId          String                  @db.ObjectId
  password        String
  passwordExpired DateTime
  passwordCreated DateTime
  passwordAttempt Int
  signUpAt      DateTime                @default(now())
  signUpFrom      ENUM_USER_SIGN_UP_FROM
  signUpWith      ENUM_USER_SIGN_UP_WITH
  salt            String
  status          ENUM_USER_STATUS        @default(ACTIVE)
  gender          ENUM_USER_GENDER?
  countryId       String                  @db.ObjectId
  lastLoginAt     DateTime?
  lastIPAddress   String?
  lastLoginFrom   ENUM_USER_LOGIN_FROM?
  lastLoginWith   ENUM_USER_SIGN_UP_WITH?
  termPolicy      Json
  photo           Json?

  // timestamps fields
  createdAt DateTime? @default(now())
  createdBy String?
  updatedAt DateTime? @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  mobileNumbers UserMobileNumber[] @relation("UserMobileNumberUser")
  verifications Verification[] @relation("UserVerifications")
  passwordHistories PasswordHistory[] @relation("UserPasswordHistories")
  activityLogs  ActivityLog[]  @relation("UserActivityLogs")
  role          Role?        @relation("UserRole", fields: [roleId], references: [id])
  country       Country?     @relation("UserCountry", fields: [countryId], references: [id])

  @@unique(fields: [username])
  @@unique(fields: [email])
  @@index(fields: [roleId])
  @@index(fields: [countryId])
  @@index(fields: [status])
  @@index(fields: [createdAt])
  @@map("Users")
}

model Verification {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  to String
  type ENUM_VERIFICATION_TYPE
  token String
  expiredAt DateTime
  verifiedAt String?
  isUsed Boolean @default(false)
  reference String

  // timestamps fields
  createdAt DateTime? @default(now())
  createdBy String?
  updatedAt DateTime? @updatedAt
  updatedBy String?

  user  User? @relation("UserVerifications", fields: [userId], references: [id])

  @@unique(fields:[userId, type])
  @@index(fields: [userId, isUsed, type])
  @@index(fields: [token])
  @@index(fields: [expiredAt])
  @@map("Verifications")
}

model PasswordHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  password  String
  salt      String
  type ENUM_PASSWORD_HISTORY_TYPE
  expiredAt DateTime

  user User? @relation("UserPasswordHistories",fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime? @default(now())
  createdBy String?
}

model ActivityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  action    ENUM_ACTIVITY_LOG_ACTION
  ipAddress String
  userAgent Json

  user User? @relation("UserActivityLogs", fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime? @default(now())
  createdBy String?

  @@index(fields: [userId])
  @@index(fields: [action])
  @@index(fields: [createdAt])
  @@map("ActivityLogs")
}

enum ENUM_USER_GENDER {
  MALE   @map("male")
  FEMALE @map("female")
}

enum ENUM_USER_STATUS {
  ACTIVE   @map("active")
  INACTIVE @map("inactive")
  BLOCKED  @map("blocked")
}

enum ENUM_USER_SIGN_UP_FROM {
  SYSTEM  @map("system")
  ADMIN   @map("admin")
  WEBSITE @map("website")
  MOBILE  @map("mobile")
}

enum ENUM_USER_SIGN_UP_WITH {
  CREDENTIAL    @map("credential")
  SOCIAL_GOOGLE @map("socialGoogle")
  SOCIAL_APPLE  @map("socialApple")
}

enum ENUM_USER_LOGIN_FROM {
  WEBSITE @map("website")
  MOBILE  @map("mobile")
}

enum ENUM_ROLE_TYPE {
  SUPER_ADMIN @map("superAdmin")
  ADMIN       @map("admin")
  USER        @map("user")
}

enum ENUM_API_KEY_TYPE {
  SYSTEM  @map("system")
  DEFAULT @map("default")
}

enum ENUM_TERM_POLICY_TYPE {
  TERMS_OF_SERVICE @map("termsOfService")
  PRIVACY          @map("privacy")
  COOKIE           @map("cookie")
  MARKETING        @map("marketing")
}

 enum ENUM_VERIFICATION_TYPE {
    MOBILE_NUMBER @map("MOBILE_NUMBER")
    EMAIL @map("EMAIL")
}

enum ENUM_PASSWORD_HISTORY_TYPE {
    SIGN_UP @map("SIGN_UP")
    FORGOT @map("FORGOT")
    ADMIN @map("ADMIN")
    PROFILE @map("PROFILE")
}

enum ENUM_ACTIVITY_LOG_ACTION {
    USER_CREATED @map("USER_CREATED")
    USER_BLOCKED @map("USER_BLOCKED")
    USER_UPDATE_STATUS @map("USER_UPDATE_STATUS")
    USER_UPDATE_PROFILE @map("USER_UPDATE_PROFILE")
    USER_UPDATE_PHOTO_PROFILE @map("USER_UPDATE_PHOTO_PROFILE")
    USER_UPDATE_PASSWORD @map("USER_UPDATE_PASSWORD")
    USER_DELETE_SELF @map("USER_DELETE_SELF")
    USER_ADD_MOBILE_NUMBER @map("USER_ADD_MOBILE_NUMBER")
    USER_UPDATE_MOBILE_NUMBER @map("USER_UPDATE_MOBILE_NUMBER")
    USER_DELETE_MOBILE_NUMBER @map("USER_DELETE_MOBILE_NUMBER")
    USER_CLAIM_USERNAME @map("USER_CLAIM_USERNAME")
}