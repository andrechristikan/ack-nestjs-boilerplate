datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}
model ApiKey {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  type          ENUM_API_KEY_TYPE @default(DEFAULT)
  name          String
  key           String
  hash          String
  isActive      Boolean           @default(true)
  startAt     DateTime?
  endAt       DateTime?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@unique(fields: [key])
  @@unique(fields: [hash])
  @@index(fields: [createdBy, createdAt])
  @@index(fields: [type])
  @@index(fields: [name])
  @@index(fields: [createdAt])
  @@map("ApiKeys")
}

model Role {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  type        ENUM_ROLE_TYPE @default(USER)
  abilities   Json[]         @default([])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  users User[] @relation("UserRole")

  @@unique(fields: [name])
  @@index(fields: [type])
  @@index(fields: [createdAt])
  @@map("Roles")
}

model Country {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  alpha2Code String
  alpha3Code String
  phoneCode  String[]
  continent  String
  timezone   String

  mobileNumbers UserMobileNumber[] @relation("UserMobileNumberCountry")
  users         User[]       @relation("UserCountry")

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@unique(fields: [alpha2Code])
  @@unique(fields: [alpha3Code])
  @@index(fields: [name])
  @@index(fields: [continent])
  @@index(fields: [createdAt])
  @@map("Countries")
}

model UserMobileNumber {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  userId       String    @db.ObjectId
  countryId    String    @db.ObjectId
  phoneCode   String
  number String
  isVerified   Boolean   @default(false)
  verifiedAt   DateTime?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  country Country? @relation("UserMobileNumberCountry", fields: [countryId], references: [id])
  user    User?    @relation("UserMobileNumberUser", fields: [userId], references: [id])

  @@unique(fields: [number])
  @@index(fields: [userId])
  @@index(fields: [isVerified])
  @@index(fields: [createdAt])
  @@map("UserMobiles")
}

model User {
  id              String                  @id @default(auto()) @map("_id") @db.ObjectId
  name            String?
  username        String
  isVerified      Boolean                 @default(false)
  verifiedAt      DateTime?
  email           String
  roleId          String                  @db.ObjectId
  password        String?
  passwordExpired DateTime?
  passwordCreated DateTime?
  passwordAttempt Int?
  signUpAt      DateTime                @default(now())
  signUpFrom      ENUM_USER_SIGN_UP_FROM
  signUpWith      ENUM_USER_SIGN_UP_WITH
  salt            String?
  status          ENUM_USER_STATUS        @default(ACTIVE)
  gender          ENUM_USER_GENDER?
  countryId       String                  @db.ObjectId
  lastLoginAt     DateTime?
  lastIPAddress   String?
  lastLoginFrom   ENUM_USER_LOGIN_FROM?
  lastLoginWith   ENUM_USER_SIGN_UP_WITH?
  termPolicy      Json
  photo           Json?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  mobileNumbers UserMobileNumber[] @relation("UserMobileNumberUser")
  verifications Verification[] @relation("UserVerifications")
  passwordHistories PasswordHistory[] @relation("UserPasswordHistories")
  activityLogs  ActivityLog[]  @relation("UserActivityLogs")
  role          Role?        @relation("UserRole", fields: [roleId], references: [id])
  country       Country?     @relation("UserCountry", fields: [countryId], references: [id])
  sessions      Session[]    @relation("UserSessions")
  acceptances  UserAcceptance[] @relation("UserAcceptanceUser")

  @@unique(fields: [username])
  @@unique(fields: [email])
  @@index(fields: [roleId])
  @@index(fields: [countryId])
  @@index(fields: [status])
  @@index(fields: [createdAt])
  @@map("Users")
}

model Verification {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  to String
  type ENUM_VERIFICATION_TYPE
  token String
  expiredAt DateTime
  verifiedAt String?
  isUsed Boolean @default(false)
  reference String

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  user  User? @relation("UserVerifications", fields: [userId], references: [id])

  @@unique(fields:[userId, type])
  @@index(fields: [userId, isUsed, type])
  @@index(fields: [token])
  @@index(fields: [expiredAt])
  @@map("Verifications")
}

model PasswordHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  password  String
  salt      String
  type ENUM_PASSWORD_HISTORY_TYPE
  expiredAt DateTime

  user User? @relation("UserPasswordHistories",fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
}

model ActivityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  action    ENUM_ACTIVITY_LOG_ACTION
  ipAddress String
  userAgent Json

  user User? @relation("UserActivityLogs", fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?

  @@index(fields: [userId])
  @@index(fields: [action])
  @@index(fields: [createdAt])
  @@map("ActivityLogs")
}

model Session {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  ipAddress String
  userAgent Json
  expiredAt DateTime
  revokedAt DateTime?
  isRevoked Boolean @default(false)

  user User? @relation("UserSessions", fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?

  @@index(fields: [userId])
  @@index(fields: [expiredAt])
  @@index(fields: [isRevoked])
  @@map("Sessions")
}

model TermPolicy {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  type ENUM_TERM_POLICY_TYPE
  content Json[] @default([])
  version Int @default(1)
  status ENUM_TERM_POLICY_STATUS @default(DRAFT)
  publishedAt DateTime?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  userAcceptances UserAcceptance[] @relation("UserAcceptanceTermPolicy")

  @@unique(fields:[type, version, status])
  @@index(fields: [type])
  @@index(fields: [status])
  @@map("TermPolicies")
}

model UserAcceptance {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  termPolicyId String @db.ObjectId
  acceptedAt DateTime @default(now())

  user User? @relation("UserAcceptanceUser", fields: [userId], references: [id])
  termPolicy TermPolicy? @relation("UserAcceptanceTermPolicy", fields: [termPolicyId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?

  @@unique(fields:[userId, termPolicyId])
  @@index(fields: [userId])
  @@index(fields: [termPolicyId])
  @@map("UserAcceptances")
}

enum ENUM_USER_GENDER {
  MALE   @map("MALE")
  FEMALE @map("FEMALE")
}

enum ENUM_USER_STATUS {
  ACTIVE   @map("ACTIVE")
  INACTIVE @map("INACTIVE")
  BLOCKED  @map("BLOCKED")
}

enum ENUM_USER_SIGN_UP_FROM {
  SYSTEM  @map("SYSTEM")
  ADMIN   @map("ADMIN")
  WEBSITE @map("WEBSITE")
  MOBILE  @map("MOBILE")
}

enum ENUM_USER_SIGN_UP_WITH {
  CREDENTIAL    @map("CREDENTIAL")
  SOCIAL_GOOGLE @map("SOCIAL_GOOGLE")
  SOCIAL_APPLE  @map("SOCIAL_APPLE")
}

enum ENUM_USER_LOGIN_FROM {
  WEBSITE @map("WEBSITE")
  MOBILE  @map("MOBILE")
}

enum ENUM_USER_LOGIN_WITH {
  CREDENTIAL    @map("CREDENTIAL")
  SOCIAL_GOOGLE @map("SOCIAL_GOOGLE")
  SOCIAL_APPLE  @map("SOCIAL_APPLE")
}

enum ENUM_ROLE_TYPE {
  SUPER_ADMIN @map("SUPER_ADMIN")
  ADMIN       @map("ADMIN")
  USER        @map("USER")
}

enum ENUM_API_KEY_TYPE {
  SYSTEM  @map("SYSTEM")
  DEFAULT @map("DEFAULT")
}

enum ENUM_TERM_POLICY_TYPE {
  TERMS_OF_SERVICE @map("TERMS_OF_SERVICE")
  PRIVACY          @map("PRIVACY")
  COOKIE           @map("COOKIE")
  MARKETING        @map("MARKETING")
}

enum ENUM_TERM_POLICY_STATUS {
  DRAFT    @map("DRAFT")
  PUBLISHED @map("PUBLISHED")
}

 enum ENUM_VERIFICATION_TYPE {
    MOBILE_NUMBER @map("MOBILE_NUMBER")
    EMAIL @map("EMAIL")
}

enum ENUM_PASSWORD_HISTORY_TYPE {
    SIGN_UP @map("SIGN_UP")
    FORGOT @map("FORGOT")
    ADMIN @map("ADMIN")
    PROFILE @map("PROFILE")
}

enum ENUM_ACTIVITY_LOG_ACTION {
    USER_CREATED @map("USER_CREATED")
    USER_BLOCKED @map("USER_BLOCKED")
    USER_UPDATE_STATUS @map("USER_UPDATE_STATUS")
    USER_UPDATE_PROFILE @map("USER_UPDATE_PROFILE")
    USER_UPDATE_PHOTO_PROFILE @map("USER_UPDATE_PHOTO_PROFILE")
    USER_CHANGE_PASSWORD @map("USER_CHANGE_PASSWORD")
    USER_DELETE_SELF @map("USER_DELETE_SELF")
    USER_ADD_MOBILE_NUMBER @map("USER_ADD_MOBILE_NUMBER")
    USER_UPDATE_MOBILE_NUMBER @map("USER_UPDATE_MOBILE_NUMBER")
    USER_DELETE_MOBILE_NUMBER @map("USER_DELETE_MOBILE_NUMBER")
    USER_CLAIM_USERNAME @map("USER_CLAIM_USERNAME")
    USER_UPDATE_PASSWORD_BY_ADMIN @map("USER_UPDATE_PASSWORD_BY_ADMIN")
    USER_LOGIN_CREDENTIAL @map("USER_LOGIN_CREDENTIAL")
    USER_LOGIN_GOOGLE @map("USER_LOGIN_GOOGLE")
    USER_LOGIN_APPLE @map("USER_LOGIN_APPLE")
    USER_VERIFIED @map("USER_VERIFIED")
    USER_SIGNED_UP @map("USER_SIGNED_UP")
}