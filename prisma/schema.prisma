datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model ApiKey {
  id       String            @id @default(auto()) @map("_id") @db.ObjectId
  type     ENUM_API_KEY_TYPE @default(default)
  name     String
  key      String
  hash     String
  isActive Boolean           @default(true)
  startAt  DateTime?
  endAt    DateTime?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@unique(fields: [key])
  @@index(fields: [name, isActive, type, createdAt])
  @@index(fields: [createdAt])
  @@map("ApiKeys")
}

model Role {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  type        ENUM_ROLE_TYPE @default(user)
  abilities   Json[]         @default([])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  users User[] @relation("UserRole")

  @@unique(fields: [name])
  @@index(fields: [name, type, createdAt])
  @@index(fields: [createdAt])
  @@map("Roles")
}

model Country {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  alpha2Code String
  alpha3Code String
  phoneCode  String[]
  continent  String
  timezone   String

  mobileNumbers UserMobileNumber[] @relation("UserMobileNumberCountry")
  users         User[]             @relation("UserCountry")

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@unique(fields: [alpha2Code])
  @@unique(fields: [alpha3Code])
  @@index(fields: [name, alpha2Code, alpha3Code, continent, createdAt])
  @@index(fields: [createdAt])
  @@map("Countries")
}

model UserMobileNumber {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  userId     String    @db.ObjectId
  countryId  String    @db.ObjectId
  phoneCode  String
  number     String
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  country       Country?       @relation("UserMobileNumberCountry", fields: [countryId], references: [id])
  user          User?          @relation("UserMobileNumberUser", fields: [userId], references: [id])
  verifications Verification[] @relation("UserMobileNumberVerification")

  @@unique(fields: [number])
  @@index(fields: [userId])
  @@index(fields: [isVerified])
  @@index(fields: [createdAt])
  @@map("UserMobiles")
}

model User {
  id              String                  @id @default(auto()) @map("_id") @db.ObjectId
  name            String?
  username        String
  isVerified      Boolean                 @default(false)
  verifiedAt      DateTime?
  email           String
  roleId          String                  @db.ObjectId
  password        String?
  passwordExpired DateTime?
  passwordCreated DateTime?
  passwordAttempt Int?
  signUpAt        DateTime                @default(now())
  signUpFrom      ENUM_USER_SIGN_UP_FROM
  signUpWith      ENUM_USER_SIGN_UP_WITH
  salt            String?
  status          ENUM_USER_STATUS        @default(active)
  gender          ENUM_USER_GENDER?
  countryId       String                  @db.ObjectId
  lastLoginAt     DateTime?
  lastIPAddress   String?
  lastLoginFrom   ENUM_USER_LOGIN_FROM?
  lastLoginWith   ENUM_USER_SIGN_UP_WITH?
  termPolicy      Json
  photo           Json?

  // timestamps fields
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  mobileNumbers     UserMobileNumber[]         @relation("UserMobileNumberUser")
  verifications     Verification[]             @relation("UserVerifications")
  passwordHistories PasswordHistory[]          @relation("UserPasswordHistories")
  activityLogs      ActivityLog[]              @relation("UserActivityLogs")
  role              Role?                      @relation("UserRole", fields: [roleId], references: [id])
  country           Country?                   @relation("UserCountry", fields: [countryId], references: [id])
  sessions          Session[]                  @relation("UserSessions")
  acceptances       TermPolicyUserAcceptance[] @relation("TermPolicyUserAcceptanceUser")
  forgotPasswords    ForgotPassword[]            @relation("UserForgotPassword")

  @@unique(fields: [username])
  @@unique(fields: [email])
  @@index(fields: [status, countryId, roleId, createdAt])
  @@index(fields: [id, deletedAt])
  @@index(fields: [email, deletedAt])
  @@index(fields: [createdAt])
  @@map("Users")
}

model Verification {
  id             String                 @id @default(auto()) @map("_id") @db.ObjectId
  userId         String                 @db.ObjectId
  mobileNumberId String?                @db.ObjectId
  to             String
  type           ENUM_VERIFICATION_TYPE
  token          String
  expiredAt      DateTime
  verifiedAt     DateTime?
  isUsed         Boolean                @default(false)
  reference      String

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  user         User?             @relation("UserVerifications", fields: [userId], references: [id])
  mobileNumber UserMobileNumber? @relation("UserMobileNumberVerification", fields: [mobileNumberId], references: [id])

  @@unique(fields: [reference])
  @@index(fields: [token, expiredAt, isUsed, type])
  @@index(fields: [token])
  @@map("Verifications")
}

model PasswordHistory {
  id        String                     @id @default(auto()) @map("_id") @db.ObjectId
  userId    String                     @db.ObjectId
  password  String
  salt      String
  type      ENUM_PASSWORD_HISTORY_TYPE
  expiredAt DateTime

  user User? @relation("UserPasswordHistories", fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
}

model ActivityLog {
  id        String                   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String                   @db.ObjectId
  action    ENUM_ACTIVITY_LOG_ACTION
  ipAddress String
  userAgent Json
  metadata  Json?

  user User? @relation("UserActivityLogs", fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?

  @@index(fields: [userId])
  @@index(fields: [createdAt])
  @@map("ActivityLogs")
}

model Session {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @db.ObjectId
  ipAddress String
  userAgent Json
  expiredAt DateTime
  revokedAt DateTime?
  isRevoked Boolean   @default(false)

  user User? @relation("UserSessions", fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index(fields: [userId])
  @@index(fields: [userId, isRevoked, expiredAt])
  @@index(fields: [createdAt])
  @@index(fields: [updatedAt])
  @@map("Sessions")
}

model TermPolicy {
  id          String                  @id @default(auto()) @map("_id") @db.ObjectId
  type        ENUM_TERM_POLICY_TYPE
  contents    Json[]                  @default([])
  version     Int                     @default(1)
  status      ENUM_TERM_POLICY_STATUS @default(draft)
  publishedAt DateTime?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  userAcceptances TermPolicyUserAcceptance[] @relation("TermPolicyUserAcceptanceTermPolicy")

  @@unique(fields: [type, version])
  @@index(fields: [type, status, createdAt])
  @@index(fields: [createdAt])
  @@index(fields: [publishedAt])
  @@index(fields: [version])
  @@map("TermPolicies")
}

model TermPolicyUserAcceptance {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  termPolicyId String   @db.ObjectId
  acceptedAt   DateTime @default(now())

  user       User?       @relation("TermPolicyUserAcceptanceUser", fields: [userId], references: [id])
  termPolicy TermPolicy? @relation("TermPolicyUserAcceptanceTermPolicy", fields: [termPolicyId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?

  @@unique(fields: [userId, termPolicyId])
  @@index(fields: [userId])
  @@index(fields: [acceptedAt])
  @@index(fields: [createdAt])
  @@map("TermPolicyUserAcceptances")
}

model FeatureFlag {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  key            String
  description    String
  isEnable       Boolean @default(true)
  rolloutPercent Int     @default(100)
  metadata       Json?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@unique(fields: [key])
  @@index(fields: [key, createdAt])
  @@index(fields: [createdAt])
  @@map("FeatureFlags")
}

model ForgotPassword {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @db.ObjectId
  to        String
  token     String
  expiredAt DateTime
  resetAt   DateTime?
  isUsed    Boolean   @default(false)
  reference String

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  user User? @relation("UserForgotPassword", fields: [userId], references: [id])

  @@unique(fields: [reference])
  @@index(fields: [token, expiredAt, isUsed])
  @@index(fields: [token])
  @@map("ForgotPasswords")
}

enum ENUM_USER_GENDER {
  male
  female
}

enum ENUM_USER_STATUS {
  active
  inactive
  blocked
}

enum ENUM_USER_SIGN_UP_FROM {
  system
  admin
  website
  mobile
}

enum ENUM_USER_SIGN_UP_WITH {
  credential
  socialGoogle
  socialApple
}

enum ENUM_USER_LOGIN_FROM {
  website
  mobile
}

enum ENUM_USER_LOGIN_WITH {
  credential
  socialGoogle
  socialApple
}

enum ENUM_ROLE_TYPE {
  superAdmin
  admin
  user
}

enum ENUM_API_KEY_TYPE {
  system
  default
}

enum ENUM_TERM_POLICY_TYPE {
  termsOfService
  privacy
  cookie
  marketing
}

enum ENUM_TERM_POLICY_STATUS {
  draft
  published
}

enum ENUM_VERIFICATION_TYPE {
  mobileNumber
  email
}

enum ENUM_PASSWORD_HISTORY_TYPE {
  signUp
  forgot
  admin
  profile
}

enum ENUM_ACTIVITY_LOG_ACTION {
  userCreated
  userBlocked
  userUpdateStatus
  userUpdateProfile
  userUpdatePhotoProfile
  userChangePassword
  userDeleteSelf
  userAddMobileNumber
  userUpdateMobileNumber
  userDeleteMobileNumber
  userClaimUsername
  userUpdatePasswordByAdmin
  userLoginCredential
  userLoginGoogle
  userLoginApple
  userVerifiedEmail
  userSignedUp
  userRevokeSession
  userRevokeSessionByAdmin
  userAcceptTermPolicy
  userForgotPassword

  adminSessionRevoke
  adminApiKeyCreate
  adminApiKeyReset
  adminApiKeyUpdate
  adminApiKeyUpdateDate
  adminApiKeyUpdateStatus
  adminApiKeyDelete
  adminRoleCreate
  adminRoleUpdate
  adminRoleDelete
  adminTermPolicyCreate
  adminTermPolicyUpdateContent
  adminTermPolicyAddContent
  adminTermPolicyRemoveContent
  adminTermPolicyPublish
  adminUserCreate
  adminUserUpdateStatus
  adminUserUpdatePassword
}
