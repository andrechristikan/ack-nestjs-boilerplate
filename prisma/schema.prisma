datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model ApiKey {
  id       String            @id @default(auto()) @map("_id") @db.ObjectId
  type     ENUM_API_KEY_TYPE @default(DEFAULT)
  name     String
  key      String
  hash     String
  isActive Boolean           @default(true)
  startAt  DateTime?
  endAt    DateTime?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@unique(fields: [key])
  @@index(fields: [name, isActive, type, createdAt])
  @@index(fields: [createdAt])
  @@map("ApiKeys")
}

model Role {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  type        ENUM_ROLE_TYPE @default(USER)
  abilities   Json[]         @default([])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  users User[] @relation("UserRole")

  @@unique(fields: [name])
  @@index(fields: [name, type, createdAt])
  @@index(fields: [createdAt])
  @@map("Roles")
}

model Country {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  alpha2Code String
  alpha3Code String
  phoneCode  String[]
  continent  String
  timezone   String

  mobileNumbers UserMobileNumber[] @relation("UserMobileNumberCountry")
  users         User[]             @relation("UserCountry")

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@unique(fields: [alpha2Code])
  @@unique(fields: [alpha3Code])
  @@index(fields: [name, alpha2Code, alpha3Code, continent, createdAt])
  @@index(fields: [createdAt])
  @@map("Countries")
}

model UserMobileNumber {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  userId     String    @db.ObjectId
  countryId  String    @db.ObjectId
  phoneCode  String
  number     String
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  country Country? @relation("UserMobileNumberCountry", fields: [countryId], references: [id])
  user    User?    @relation("UserMobileNumberUser", fields: [userId], references: [id])

  @@unique(fields: [number])
  @@index(fields: [userId])
  @@index(fields: [isVerified])
  @@index(fields: [createdAt])
  @@map("UserMobiles")
}

model User {
  id              String                  @id @default(auto()) @map("_id") @db.ObjectId
  name            String?
  username        String
  isVerified      Boolean                 @default(false)
  verifiedAt      DateTime?
  email           String
  roleId          String                  @db.ObjectId
  password        String?
  passwordExpired DateTime?
  passwordCreated DateTime?
  passwordAttempt Int?
  signUpAt        DateTime                @default(now())
  signUpFrom      ENUM_USER_SIGN_UP_FROM
  signUpWith      ENUM_USER_SIGN_UP_WITH
  salt            String?
  status          ENUM_USER_STATUS        @default(ACTIVE)
  gender          ENUM_USER_GENDER?
  countryId       String                  @db.ObjectId
  lastLoginAt     DateTime?
  lastIPAddress   String?
  lastLoginFrom   ENUM_USER_LOGIN_FROM?
  lastLoginWith   ENUM_USER_SIGN_UP_WITH?
  termPolicy      Json
  photo           Json?

  // timestamps fields
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  mobileNumbers     UserMobileNumber[]         @relation("UserMobileNumberUser")
  verifications     Verification[]             @relation("UserVerifications")
  passwordHistories PasswordHistory[]          @relation("UserPasswordHistories")
  activityLogs      ActivityLog[]              @relation("UserActivityLogs")
  role              Role?                      @relation("UserRole", fields: [roleId], references: [id])
  country           Country?                   @relation("UserCountry", fields: [countryId], references: [id])
  sessions          Session[]                  @relation("UserSessions")
  acceptances       TermPolicyUserAcceptance[] @relation("TermPolicyUserAcceptanceUser")

  @@unique(fields: [username])
  @@unique(fields: [email])
  @@index(fields: [status, countryId, roleId, createdAt])
  @@index(fields: [id, deletedAt])
  @@index(fields: [email, deletedAt])
  @@index(fields: [createdAt])
  @@map("Users")
}

model Verification {
  id         String                 @id @default(auto()) @map("_id") @db.ObjectId
  userId     String                 @db.ObjectId
  to         String
  type       ENUM_VERIFICATION_TYPE
  token      String
  expiredAt  DateTime
  verifiedAt DateTime?
  isUsed     Boolean                @default(false)
  reference  String

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  user User? @relation("UserVerifications", fields: [userId], references: [id])

  @@unique(fields: [reference])
  @@index(fields: [token, expiredAt, isUsed, type])
  @@index(fields: [token])
  @@map("Verifications")
}

model PasswordHistory {
  id        String                     @id @default(auto()) @map("_id") @db.ObjectId
  userId    String                     @db.ObjectId
  password  String
  salt      String
  type      ENUM_PASSWORD_HISTORY_TYPE
  expiredAt DateTime

  user User? @relation("UserPasswordHistories", fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
}

model ActivityLog {
  id        String                   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String                   @db.ObjectId
  action    ENUM_ACTIVITY_LOG_ACTION
  ipAddress String
  userAgent Json
  metadata  Json?

  user User? @relation("UserActivityLogs", fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?

  @@index(fields: [userId])
  @@index(fields: [createdAt])
  @@map("ActivityLogs")
}

model Session {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @db.ObjectId
  ipAddress String
  userAgent Json
  expiredAt DateTime
  revokedAt DateTime?
  isRevoked Boolean   @default(false)

  user User? @relation("UserSessions", fields: [userId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index(fields: [userId])
  @@index(fields: [userId, isRevoked, expiredAt])
  @@index(fields: [createdAt])
  @@index(fields: [updatedAt])
  @@map("Sessions")
}

model TermPolicy {
  id          String                  @id @default(auto()) @map("_id") @db.ObjectId
  type        ENUM_TERM_POLICY_TYPE
  contents    Json[]                  @default([])
  version     Int                     @default(1)
  status      ENUM_TERM_POLICY_STATUS @default(DRAFT)
  publishedAt DateTime?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  userAcceptances TermPolicyUserAcceptance[] @relation("TermPolicyUserAcceptanceTermPolicy")

  @@unique(fields: [type, version])
  @@index(fields: [type, status, createdAt])
  @@index(fields: [createdAt])
  @@index(fields: [publishedAt])
  @@index(fields: [version])
  @@map("TermPolicies")
}

model TermPolicyUserAcceptance {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  termPolicyId String   @db.ObjectId
  acceptedAt   DateTime @default(now())

  user       User?       @relation("TermPolicyUserAcceptanceUser", fields: [userId], references: [id])
  termPolicy TermPolicy? @relation("TermPolicyUserAcceptanceTermPolicy", fields: [termPolicyId], references: [id])

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?

  @@unique(fields: [userId, termPolicyId])
  @@index(fields: [userId])
  @@index(fields: [acceptedAt])
  @@index(fields: [createdAt])
  @@map("TermPolicyUserAcceptances")
}

model FeatureFlag {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  key            String
  description    String
  isEnable       Boolean @default(true)
  rolloutPercent Int     @default(100)
  metadata       Json?

  // timestamps fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@unique(fields: [key])
  @@index(fields: [key, createdAt])
  @@index(fields: [createdAt])
  @@map("FeatureFlags")
}

enum ENUM_USER_GENDER {
  MALE   @map("male")
  FEMALE @map("female")
}

enum ENUM_USER_STATUS {
  ACTIVE   @map("active")
  INACTIVE @map("inactive")
  BLOCKED  @map("blocked")
}

enum ENUM_USER_SIGN_UP_FROM {
  SYSTEM  @map("system")
  ADMIN   @map("admin")
  WEBSITE @map("website")
  MOBILE  @map("mobile")
}

enum ENUM_USER_SIGN_UP_WITH {
  CREDENTIAL    @map("credential")
  SOCIAL_GOOGLE @map("socialGoogle")
  SOCIAL_APPLE  @map("socialApple")
}

enum ENUM_USER_LOGIN_FROM {
  WEBSITE @map("website")
  MOBILE  @map("mobile")
}

enum ENUM_USER_LOGIN_WITH {
  CREDENTIAL    @map("credential")
  SOCIAL_GOOGLE @map("socialGoogle")
  SOCIAL_APPLE  @map("socialApple")
}

enum ENUM_ROLE_TYPE {
  SUPER_ADMIN @map("superAdmin")
  ADMIN       @map("admin")
  USER        @map("user")
}

enum ENUM_API_KEY_TYPE {
  SYSTEM  @map("system")
  DEFAULT @map("default")
}

enum ENUM_TERM_POLICY_TYPE {
  TERMS_OF_SERVICE @map("termsOfService")
  PRIVACY          @map("privacy")
  COOKIE           @map("cookie")
  MARKETING        @map("marketing")
}

enum ENUM_TERM_POLICY_STATUS {
  DRAFT     @map("draft")
  PUBLISHED @map("published")
}

enum ENUM_VERIFICATION_TYPE {
  MOBILE_NUMBER @map("mobileNumber")
  EMAIL         @map("email")
}

enum ENUM_PASSWORD_HISTORY_TYPE {
  SIGN_UP @map("signUp")
  FORGOT  @map("forgot")
  ADMIN   @map("admin")
  PROFILE @map("profile")
}

enum ENUM_ACTIVITY_LOG_ACTION {
  USER_CREATED                  @map("userCreated")
  USER_BLOCKED                  @map("userBlocked")
  USER_UPDATE_STATUS            @map("userUpdateStatus")
  USER_UPDATE_PROFILE           @map("userUpdateProfile")
  USER_UPDATE_PHOTO_PROFILE     @map("userUpdatePhotoProfile")
  USER_CHANGE_PASSWORD          @map("userChangePassword")
  USER_DELETE_SELF              @map("userDeleteSelf")
  USER_ADD_MOBILE_NUMBER        @map("userAddMobileNumber")
  USER_UPDATE_MOBILE_NUMBER     @map("userUpdateMobileNumber")
  USER_DELETE_MOBILE_NUMBER     @map("userDeleteMobileNumber")
  USER_CLAIM_USERNAME           @map("userClaimUsername")
  USER_UPDATE_PASSWORD_BY_ADMIN @map("userUpdatePasswordByAdmin")
  USER_LOGIN_CREDENTIAL         @map("userLoginCredential")
  USER_LOGIN_GOOGLE             @map("userLoginGoogle")
  USER_LOGIN_APPLE              @map("userLoginApple")
  USER_VERIFIED                 @map("userVerified")
  USER_SIGNED_UP                @map("userSignedUp")
  USER_REVOKE_SESSION           @map("userRevokeSession")
  USER_REVOKE_SESSION_BY_ADMIN  @map("userRevokeSessionByAdmin")
  USER_ACCEPT_TERM_POLICY       @map("userAcceptTermPolicy")
  USER_VERIFIED_EMAIL           @map("userVerifiedEmail")

  ADMIN_SESSION_REVOKE             @map("adminSessionRevoke")
  ADMIN_API_KEY_CREATE             @map("adminApiKeyCreate")
  ADMIN_API_KEY_RESET              @map("adminApiKeyReset")
  ADMIN_API_KEY_UPDATE             @map("adminApiKeyUpdate")
  ADMIN_API_KEY_UPDATE_DATE        @map("adminApiKeyUpdateDate")
  ADMIN_API_KEY_UPDATE_INACTIVE    @map("adminApiKeyUpdateInactive")
  ADMIN_API_KEY_UPDATE_ACTIVE      @map("adminApiKeyUpdateActive")
  ADMIN_API_KEY_DELETE             @map("adminApiKeyDelete")
  ADMIN_ROLE_CREATE                @map("adminRoleCreate")
  ADMIN_ROLE_UPDATE                @map("adminRoleUpdate")
  ADMIN_ROLE_DELETE                @map("adminRoleDelete")
  ADMIN_TERM_POLICY_CREATE         @map("adminTermPolicyCreate")
  ADMIN_TERM_POLICY_UPDATE_CONTENT @map("adminTermPolicyUpdateContent")
  ADMIN_TERM_POLICY_ADD_CONTENT    @map("adminTermPolicyAddContent")
  ADMIN_TERM_POLICY_REMOVE_CONTENT @map("adminTermPolicyRemoveContent")
  ADMIN_TERM_POLICY_PUBLISH        @map("adminTermPolicyPublish")
  ADMIN_USER_CREATE                @map("adminUserCreate")
  ADMIN_USER_UPDATE_STATUS         @map("adminUserUpdateStatus")
  ADMIN_USER_UPDATE_PASSWORD       @map("adminUserUpdatePassword")
}
