name: ReleaseWithSsh
on:
    workflow_dispatch:
    # push:
    #     branches:
    #         - main
    #         - staging
    #         - development

env:
    DOCKERFILE: ci/dockerfile

jobs:
    build_image:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                include:
                    - branch: main
                      env: production
                    - branch: development
                      env: development
                    - branch: staging
                      env: staging

        steps:
            - name: Git checkout
              uses: actions/checkout@v6

            - name: Get short sha commit
              id: git
              run: |
                  echo "short_sha=$(git rev-parse --short $GITHUB_SHA)" >> "$GITHUB_OUTPUT"

            - name: Get latest version
              id: version
              uses: martinbeentjes/npm-get-version-action@main

            - name: Log info
              run: |
                  echo Branch name is: ${{ github.ref_name }}
                  echo Short sha: ${{ steps.git.outputs.short_sha }}
                  echo Version is: ${{ steps.version.outputs.current-version }}

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ vars.DOCKER_REGISTRY_URL }}
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build & Push
              if: ${{ github.ref_name == matrix.branch }}
              run: |
                  docker build --build-arg NODE_ENV=${{ matrix.env }} -t ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ matrix.env }} -f ${{ env.DOCKERFILE }} .
                  docker tag ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ matrix.env }} ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:sha-${{ steps.git.outputs.short_sha }}
                  docker push ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:sha-${{ steps.git.outputs.short_sha }}
                  docker push ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ matrix.env }}
                  
                  # Push latest tag only for production
                  if [ "${{ matrix.env }}" = "production" ]; then
                    docker tag ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ matrix.env }} ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:latest
                    docker push ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:latest
                  fi

    deploy:
        needs: [build_image]
        runs-on: ubuntu-latest

        strategy:
            matrix:
                include:
                    - branch: main
                      env: production
                    - branch: development
                      env: development
                    - branch: staging
                      env: staging

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set SSH variables
              if: ${{ github.ref_name == matrix.branch }}
              run: |
                  if [ "${{ matrix.env }}" = "production" ]; then
                    echo "SSH_HOST=${{ secrets.PROD_SSH_HOST }}" >> $GITHUB_ENV
                    echo "SSH_USER=${{ secrets.PROD_SSH_USER }}" >> $GITHUB_ENV
                    echo "SSH_KEY<<EOF" >> $GITHUB_ENV
                    echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV
                  elif [ "${{ matrix.env }}" = "development" ]; then
                    echo "SSH_HOST=${{ secrets.DEV_SSH_HOST }}" >> $GITHUB_ENV
                    echo "SSH_USER=${{ secrets.DEV_SSH_USER }}" >> $GITHUB_ENV
                    echo "SSH_KEY<<EOF" >> $GITHUB_ENV
                    echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV
                  elif [ "${{ matrix.env }}" = "staging" ]; then
                    echo "SSH_HOST=${{ secrets.STAGING_SSH_HOST }}" >> $GITHUB_ENV
                    echo "SSH_USER=${{ secrets.STAGING_SSH_USER }}" >> $GITHUB_ENV
                    echo "SSH_KEY<<EOF" >> $GITHUB_ENV
                    echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV
                  fi

            - name: Deploy via SSH
              if: ${{ github.ref_name == matrix.branch }}
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ env.SSH_HOST }}
                  username: ${{ env.SSH_USER }}
                  key: ${{ env.SSH_KEY }}
                  port: ${{ secrets.SSH_PORT }}
                  script: |
                      docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }} ${{ vars.DOCKER_REGISTRY_URL }}
                      docker pull ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ matrix.env }}
                      docker stop ${{ vars.DOCKER_CONTAINER_NAME }} && docker rm ${{ vars.DOCKER_CONTAINER_NAME }} || true
                      docker network create app-network --driver=bridge 2>/dev/null || true
                      docker run -itd --env NODE_ENV=${{ matrix.env }} --hostname ${{ vars.DOCKER_CONTAINER_NAME }} --publish ${{ vars.DOCKER_CONTAINER_PORT }}:3000 --network app-network --restart unless-stopped --name ${{ vars.DOCKER_CONTAINER_NAME }} ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ matrix.env }}

    clean:
        needs: [deploy]
        runs-on: ubuntu-latest

        strategy:
            matrix:
                include:
                    - branch: main
                      env: production
                    - branch: development
                      env: development
                    - branch: staging
                      env: staging

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set SSH variables
              if: ${{ github.ref_name == matrix.branch }}
              run: |
                  if [ "${{ matrix.env }}" = "production" ]; then
                    echo "SSH_HOST=${{ secrets.PROD_SSH_HOST }}" >> $GITHUB_ENV
                    echo "SSH_USER=${{ secrets.PROD_SSH_USER }}" >> $GITHUB_ENV
                    echo "SSH_KEY<<EOF" >> $GITHUB_ENV
                    echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV
                  elif [ "${{ matrix.env }}" = "development" ]; then
                    echo "SSH_HOST=${{ secrets.DEV_SSH_HOST }}" >> $GITHUB_ENV
                    echo "SSH_USER=${{ secrets.DEV_SSH_USER }}" >> $GITHUB_ENV
                    echo "SSH_KEY<<EOF" >> $GITHUB_ENV
                    echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV
                  elif [ "${{ matrix.env }}" = "staging" ]; then
                    echo "SSH_HOST=${{ secrets.STAGING_SSH_HOST }}" >> $GITHUB_ENV
                    echo "SSH_USER=${{ secrets.STAGING_SSH_USER }}" >> $GITHUB_ENV
                    echo "SSH_KEY<<EOF" >> $GITHUB_ENV
                    echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV
                  fi

            - name: Clean Docker Images
              if: ${{ github.ref_name == matrix.branch }}
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ env.SSH_HOST }}
                  username: ${{ env.SSH_USER }}
                  key: ${{ env.SSH_KEY }}
                  port: ${{ secrets.SSH_PORT }}
                  script: |
                      docker image prune --force
                      docker rmi $(docker images ${{ vars.DOCKER_REGISTRY_URL }}/${{ vars.DOCKER_IMAGE_NAME }}/** -q) --force || true